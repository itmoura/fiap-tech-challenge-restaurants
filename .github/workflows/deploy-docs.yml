name: ğŸ“š Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/deploy-docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install mkdocs-material
          pip install mkdocs-with-pdf
          pip install mkdocs-minify-plugin
          pip install pymdown-extensions
          pip install mkdocs-mermaid2-plugin

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ğŸ“Š Generate API Documentation
        run: |
          # Create API documentation from OpenAPI spec if available
          if [ -f "src/main/resources/openapi.yml" ]; then
            echo "ğŸ“‹ OpenAPI spec found, generating additional docs..."
            # Add OpenAPI doc generation here if needed
          fi

      - name: ğŸ—ï¸ Build documentation
        env:
          ENABLE_PDF_EXPORT: true
        run: |
          echo "ğŸ—ï¸ Building MkDocs site..."
          mkdocs build --verbose --clean
          
          # Verify build output
          if [ ! -d "site" ]; then
            echo "âŒ Build failed - site directory not found"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"
          echo "ğŸ“ Site contents:"
          ls -la site/

      - name: ğŸ“„ Generate PDF Documentation
        env:
          ENABLE_PDF_EXPORT: true
        run: |
          echo "ğŸ“„ Generating PDF documentation..."
          
          # Create PDF directory if it doesn't exist
          mkdir -p site/pdf
          
          # Generate PDF using mkdocs-with-pdf
          mkdocs build --config-file mkdocs.yml
          
          # Verify PDF was generated
          if [ -f "site/pdf/documentation.pdf" ]; then
            echo "âœ… PDF generated successfully"
            ls -la site/pdf/
          else
            echo "âš ï¸ PDF generation failed, continuing without PDF"
          fi

      - name: ğŸ” Validate HTML
        run: |
          echo "ğŸ” Validating generated HTML..."
          
          # Check for broken links (basic validation)
          find site -name "*.html" -exec grep -l "href.*#.*" {} \; | head -5
          
          # Check if main pages exist
          required_pages=("index.html" "installation/prerequisites/index.html" "api/overview/index.html")
          for page in "${required_pages[@]}"; do
            if [ -f "site/$page" ]; then
              echo "âœ… Found: $page"
            else
              echo "âŒ Missing: $page"
              exit 1
            fi
          done

      - name: ğŸ“Š Generate Site Statistics
        run: |
          echo "ğŸ“Š Documentation Statistics:"
          echo "=========================="
          echo "ğŸ“„ Total HTML files: $(find site -name "*.html" | wc -l)"
          echo "ğŸ–¼ï¸ Total images: $(find site -name "*.png" -o -name "*.jpg" -o -name "*.gif" -o -name "*.svg" | wc -l)"
          echo "ğŸ“± Total CSS files: $(find site -name "*.css" | wc -l)"
          echo "âš¡ Total JS files: $(find site -name "*.js" | wc -l)"
          echo "ğŸ“¦ Total size: $(du -sh site | cut -f1)"
          echo "=========================="

      - name: ğŸš€ Setup Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  # Deploy job (only on main branch)
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“¢ Deployment Summary
        run: |
          echo "ğŸ‰ Documentation deployed successfully!"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”„ Commit: ${{ github.sha }}"

  # Notification job
  notify:
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build, deploy]
    steps:
      - name: ğŸ“¢ Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Documentation deployment successful!"
          echo "ğŸ”— Live site: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“š API docs are now available online"

      - name: âŒ Failure Notification
        if: needs.build.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "âŒ Documentation deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ› ï¸ Common issues:"
          echo "   - Missing dependencies"
          echo "   - Invalid markdown syntax"
          echo "   - Broken links or references"

  # Quality checks (runs on PRs)
  quality-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install mkdocs-material
          pip install pymdown-extensions

      - name: ğŸ” Lint Markdown
        run: |
          echo "ğŸ” Checking markdown files..."
          
          # Check for common markdown issues
          find docs -name "*.md" -exec grep -l "]()" {} \; | while read file; do
            echo "âš ï¸ Empty link found in: $file"
          done
          
          # Check for missing alt text in images
          find docs -name "*.md" -exec grep -l "!\[\](" {} \; | while read file; do
            echo "âš ï¸ Image without alt text in: $file"
          done

      - name: ğŸ—ï¸ Test Build
        run: |
          echo "ğŸ—ï¸ Testing documentation build..."
          mkdocs build --strict
          echo "âœ… Build test passed"

      - name: ğŸ“Š PR Summary
        run: |
          echo "ğŸ“Š Pull Request Documentation Check"
          echo "=================================="
          echo "âœ… Markdown syntax: Valid"
          echo "âœ… Build test: Passed"
          echo "ğŸ“„ Modified files:"
          git diff --name-only origin/main...HEAD | grep -E "\.(md|yml)$" || echo "No documentation files changed"
