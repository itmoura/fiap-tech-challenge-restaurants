name: ğŸ“š Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'web-docs/**'
      - '.github/workflows/deploy-static-docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-documentation:
    name: ğŸš€ Deploy HTML Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Verify Documentation Structure
        run: |
          echo "ğŸ” Checking web-docs structure..."
          ls -la web-docs/
          
          echo "ğŸ“„ Checking required files..."
          if [ -f "web-docs/index.html" ]; then
            echo "âœ… index.html found"
          else
            echo "âŒ index.html not found"
            exit 1
          fi
          
          if [ -d "web-docs/css" ]; then
            echo "âœ… CSS directory found"
          else
            echo "âŒ CSS directory not found"
            exit 1
          fi
          
          if [ -d "web-docs/js" ]; then
            echo "âœ… JS directory found"
          else
            echo "âŒ JS directory not found"
            exit 1
          fi
          
          if [ -d "web-docs/pages" ]; then
            echo "âœ… Pages directory found"
            echo "ğŸ“‹ Available pages:"
            ls -1 web-docs/pages/ | head -10
          else
            echo "âŒ Pages directory not found"
            exit 1
          fi

      - name: ğŸ“Š Generate Documentation Stats
        run: |
          echo "ğŸ“Š Documentation Statistics"
          echo "=========================="
          echo "ğŸ“„ Total HTML files: $(find web-docs -name "*.html" | wc -l)"
          echo "ğŸ¨ CSS files: $(find web-docs -name "*.css" | wc -l)"
          echo "âš¡ JS files: $(find web-docs -name "*.js" | wc -l)"
          echo "ğŸ“ Total size: $(du -sh web-docs | cut -f1)"
          echo "=========================="

      - name: ğŸ”§ Optimize Files
        run: |
          echo "ğŸ”§ Optimizing documentation files..."
          
          # Remove any .DS_Store files (macOS)
          find web-docs -name ".DS_Store" -delete || true
          
          # Remove any backup files
          find web-docs -name "*.bak" -delete || true
          find web-docs -name "*~" -delete || true
          
          echo "âœ… Optimization completed"

      - name: ğŸš€ Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload Documentation Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./web-docs

      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ” Post-Deploy Validation
        run: |
          echo "ğŸ” Validating deployment..."
          
          # Wait a moment for deployment to propagate
          sleep 30
          
          SITE_URL="${{ steps.deployment.outputs.page_url }}"
          echo "ğŸŒ Site URL: $SITE_URL"
          
          # Basic connectivity test
          if curl -f -s "$SITE_URL" > /dev/null; then
            echo "âœ… Site is accessible"
          else
            echo "âš ï¸ Site may not be immediately accessible (normal for first deploy)"
          fi

      - name: ğŸ“¢ Deployment Success
        run: |
          echo "ğŸ‰ HTML documentation deployed successfully!"
          echo ""
          echo "ğŸ“Š Deployment Summary:"
          echo "======================"
          echo "ğŸ”— Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo ""
          echo "ğŸ“š Available Sections:"
          echo "â€¢ ğŸ  Home - Overview and quick start"
          echo "â€¢ ğŸ“‹ Installation - Prerequisites and setup"
          echo "â€¢ ğŸ“š API Reference - Complete endpoint documentation"
          echo "â€¢ ğŸ—ï¸ Architecture - System design and patterns"
          echo "â€¢ ğŸ‘¤ About - Author and license information"
          echo ""
          echo "ğŸ¯ Features:"
          echo "â€¢ ğŸŒ™ Dark mode AWS-style design"
          echo "â€¢ ğŸ“± Responsive mobile-friendly layout"
          echo "â€¢ ğŸ” Interactive navigation sidebar"
          echo "â€¢ ğŸ“‹ Copy-to-clipboard code blocks"
          echo "â€¢ âš¡ Fast loading static HTML"
          echo ""
          echo "ğŸ”§ This is now the ONLY documentation workflow"
          echo "â€¢ MkDocs workflows have been removed"
          echo "â€¢ Only HTML static documentation is deployed"
          echo "â€¢ Faster, more reliable, and easier to maintain"

  # Notification job for failures
  notify-failure:
    name: ğŸ“¢ Notify Failure
    runs-on: ubuntu-latest
    needs: deploy-documentation
    if: failure()
    
    steps:
      - name: âŒ Deployment Failed
        run: |
          echo "âŒ Documentation deployment failed!"
          echo ""
          echo "ğŸ” Possible causes:"
          echo "â€¢ Missing required files (index.html, CSS, JS)"
          echo "â€¢ Invalid HTML structure"
          echo "â€¢ GitHub Pages configuration issues"
          echo "â€¢ File size or count limits exceeded"
          echo ""
          echo "ğŸ› ï¸ Troubleshooting steps:"
          echo "1. Check the job logs above for specific errors"
          echo "2. Verify all files exist in web-docs directory"
          echo "3. Test HTML files locally before pushing"
          echo "4. Ensure GitHub Pages is enabled in repository settings"
          echo ""
          echo "ğŸ“ If issues persist:"
          echo "â€¢ Check GitHub Pages status: https://www.githubstatus.com/"
          echo "â€¢ Verify repository permissions and settings"
          echo "â€¢ Try manual deployment via Actions tab"
